<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=1,minimum-scale=1">
	<title>chat room</title>
	<script type="text/javascript">
		(function(){
			var html = document.documentElement;
			var hWidth = html.getBoundingClientRect().width;
			if(hWidth >= 540){
				document.documentElement.style.width = "540px"
				hWidth = 540
			}
			html.style.fontSize = (hWidth / 750) * 100 + "px";
		})();
	</script>
	<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/static/index.css">
	<link rel="stylesheet" type="text/css" href="/static/up.css">
	<script type="text/javascript" src="/static/js/miao.js"></script>

</head>
<body>
<div class="chat-page">
	<div class="login-box">
		<h3>用户登录</h3>
		<div class='avatar'>
			<img src="/static/user.jpg">
			<input type="file" id="upFile">			
		</div>
		<input type="text" name="name" class="name" placeholder="请输入登录用名">
		<button class="loginBtn">登录</button>
	</div>
	<div class="menu">
		<ul class="user-list">
			
		</ul>
	</div>
	<div class="room-box">
		<div class="top-title">
			聊天室在线人数（<span class="userNum"></span>）
			<img src="/static/left.png" id="img">
			<span class="msg-num ico">
				<i class="iconfont">&#xe631;</i>
				<span>2</span>
			</span>
		</div>
		<div class="view">
			<div class="chat-bar">
				
			</div>
		</div>
		<div class="other-send">
			<div class="img-click pic-click">
				<img src="/static/pic.png">
				<input type="file" id="file" accept="image/*">
			</div>	
			<div class="img-click emoji-click">		
				<img src="/static/emoj.png">
			</div>
			<div class="img-click icon-click">
				<i class="iconfont font">&#xe630;</i>
				<input type="color" name="color" value="#000000" id="color">		
			</div>
		</div>
		<div class="bottom-side">
			<input type="text" name="send" class="send">
			<button class="sendBtn">发送</button>
		</div>
		<div class="emoji-box">
			
		</div>
	</div>
	<div class="one2one-box" data-id="">
		<div class="one2one-top-title">
			<span class="text"></span>
			<i class="iconfont">&#xe6d3;</i>
		</div>
		<div class="one2one-view">
			<div class="one2one-chat-bar">
				
			</div>
		</div>
		<div class="one2one-other-send">
			<div class="one2one-img-click one2one-pic-click">
				<img src="/static/pic.png">
				<input type="file" id="one2one-file" accept="image/*">
			</div>	
			<div class="one2one-img-click one2one-emoji-click">		
				<img src="/static/emoj.png">
			</div>
			<div class="one2one-img-click one2one-icon-click">
				<i class="iconfont one2one-font">&#xe630;</i>
				<input type="color" name="one2one-color" value="#000000" id="one2one-color">		
			</div>
		</div>
		<div class="one2one-bottom-side">
			<input type="text" name="one2one-send" class="one2one-send">
			<button class="one2one-sendBtn">发送</button>
		</div>
		<div class="one2one-emoji-box">
			
		</div>
	</div>
</div>
<div id="wrap">
	<section class="page pageHide">
		<header>
			<i class="iconfont back" id="back">&#xe63b;</i>
			图片编辑 <a href="javascript:;" class="btn" id="saveBtn">保存</a>
		</header>
		<div class="con">
			<canvas id="c"></canvas>
			<div id="select">
				<span class="left-top"></span>
				<span class="left-bottom"></span>
				<span class="right-top"></span>
				<span class="right-bottom"></span>
			</div>
		</div>
	</section>
	<section class="page pageHide">
		<header>
			<i class="iconfont back" id="back2">&#xe63b;</i>
			设置头像
			<a href="javascript:;" class="btn" id="choose">设为头像</a>
		</header>
		<canvas id="c2"></canvas>
		<img src="" id="img2">
	</section>
</div>
</body>
<script src="/static/js/up.js"></script>
<script src="/static/js/socket.io.js"></script>
<script src="/static/js/index.js"></script>
<script src="/static/js/compress.js"></script>
<script src="/static/js/menu.js"></script>

<script>
var roomDia = [];

var socket = io.connect();
var userId = '';
var name = "";
var dialogObj = {};
var avatarData = '/static/user.jpg';

//登录
$(".loginBtn").click(function(){
	name = $(".name").val();
	if(!name){
		alert('请输入登录用名')
		return
	}
	userId = socket.id;

	socket.emit('login', {username: name,id: socket.id, avatarData});				
})
//发送图片
$("#file").change(function(){
	var file = this.files[0];
	if(file.size/1024 > 40){ //大于40kb
		photoCompress(
			file,
			{
				quality: 0.6,
				width: 260
			},
			function(base64){
				emitPic(base64)
			}
		)
	}else{
		var reader = new FileReader();
		reader.readAsDataURL(file)
		reader.onerror = function(){
			console.log('读取文件失败，请重试！')
		}
		reader.onload = function() {
			var src = reader.result;
			emitPic(src)
		}
	}

	function emitPic(src) {
		socket.emit('sendPic',{
			img: src,
			avatarData
		})
		$("#file").val("")
	}

	
})

//自己登录成功
socket.on('user_login_success',function(data){
	$(".login-box").hide()
	$(".room-box").css("display","flex")
	name = $(".name").val();
	displayUser(data)
})
//自己登录失败
socket.on('login_fail',function(msg){
	alert("用户已存在")
})
//登录成功提醒
socket.on('login_success',function(data){
	var html = `<div class="sys-msg">
					<span>系统消息：${data.user.username}已加入群聊</span>
				</div>`
	roomDia.push(html);

	$(".chat-bar").html(roomDia.join(''))
	$(".view").scrollTop($(".chat-bar").height())
	displayUser(data)
})

//退出成功提醒
socket.on('logout_success',function(data){
	var html = `<div class="sys-msg">
					<span>缪文文提醒：${data.user.username}已退出群聊</span>
				</div>`
	roomDia.push(html);

	$(".chat-bar").html(roomDia.join(''))
	$(".view").scrollTop($(".chat-bar").height())
	displayUser (data)
	//用户为当前用户返回登录页
	if(data.user.username == name){
		$(".login-box").show()
		$(".room-box").hide()
		name = null
	}
})
//？
socket.on("logout",function(){
	//貌似不会走这步
	$(".login-box").show()
	$(".room-box").hide()
	$(".one2one-box").hide()
	$(".menu").hide()
	name = null
})
//？
socket.on("user_logout",function(){
	$(".login-box").show()
	$(".room-box").hide()
	$(".one2one-box").hide()
	$(".menu").hide()
	name = null
})



function displayUser (data) {
	var {users} = data;
	var len = users.length;
	$(".userNum").html(len);
	var html = "";
	for (var i = 0; i < len; i++) {
		if(users[i].username == name){
			html += `<li data-id="${users[i].id}">
						<img src="${users[i].avatarData}">
						<span class="name">${users[i].username}</span>
						<span class="dot"></span>
					</li>`
			continue
		}

		if(dialogObj[users[i].id]&&dialogObj[users[i].id].unread > 0){

			html += `<li data-id="${users[i].id}">
				<img src="${users[i].avatarData}">
				<span class="name">${users[i].username}</span>
				<span class="num ico">
					<i class="iconfont">&#xe631;</i>
					<span>${dialogObj[users[i].id].unread}</span>
				</span>
			</li>`
		}else{
			html += `<li data-id="${users[i].id}">
					<img src="${users[i].avatarData}">
					<span class="name">${users[i].username}</span>
				</li>`
		}
		
	}
	$(".user-list").html(html)
}

function createTextLi(data,pos) {
	if(data.img){
		console.log(data)
		if(pos === 'right'){
			
			return `<div class="chat-li right-li">
						<img src="${data.avatarData}">
						<div class="message-box">
							<div class="img-box">
								<img src="${data.img}">
							</div>
						</div>
					</div>`
		}else if(pos === 'left'){
			return `<div class="chat-li left-li">
						<img src="${data.avatarData}">
						<div class="message-box">
							<p>${data.username}</p>
							<div class="message-box">
								<div class="img-box">
									<img src="${data.img}">
								</div>
							</div>
						</div>
					</div>`
		}
	}else{
		var newVal = data.val.replace(/\[(\d+)\]/g,function(match,p1){
			return '<img src="/static/emoji/emoji ('+p1+').png">'
		})
		if(pos === 'right'){
			
			
			return `<div class="chat-li right-li">
						<img src="${data.avatarData}">
						<div class="message-box">
							<div class="msg" style="color:${data.color}">
								${newVal}
							</div>
						</div>
					</div>`
		}else if(pos === 'left'){
			return `<div class="chat-li left-li">
						<img src="${data.avatarData}">
						<div class="message-box">
							<p>${data.username}</p>
							<div class="msg" style="color:${data.color}">
								${newVal}
							</div>
						</div>
					</div>`
		}
	}
}
//提示消息
function msgNum(){
	var len = 0;
	for(key in dialogObj){
		if(dialogObj[key].unread){
			len += dialogObj[key].unread
		}
	}

	if(len > 0){
		$(".msg-num").show();
		$(".msg-num span").text(len)
	}else{
		$(".msg-num").hide();
	}
}


//发送消息
$(".sendBtn").click(function(){
	var val = $(".send").val();
	if(!val){
		return
	}
	var color = $("#color").val();		
	socket.emit('send', {val: val, color: color, avatarData: avatarData});
	$(".send").val(''); 

})


//接收自己发送的消息
socket.on("send_success",function(data){
	
	roomDia.push(createTextLi(data,'right'));

	$(".chat-bar").html(roomDia.join(''))
	$(".view").scrollTop($(".chat-bar").height())
})
//接收其他人发送的消息
socket.on("boradcast",function(data){

	roomDia.push(createTextLi(data,'left'));

	$(".chat-bar").html(roomDia.join(''))
	$(".view").scrollTop($(".chat-bar").height())
})

//接收自己发送的图片		
socket.on("sendPic_success",function(data){
	var html = createTextLi(data,'right');

	roomDia.push(html);

	$(".chat-bar").html(roomDia.join(''))
	//图片加载完再滚动条到底部
	var image = new Image();
	image.src = data.img;
	image.onload = function(){
		$(".view").scrollTop($(".chat-bar").height())
	}
	
})
//接收其他人发送的图片
socket.on("boradcastPic",function(data){
	var html = createTextLi(data,'left');
	roomDia.push(html);
	
	$(".chat-bar").html(roomDia.join(''));
	var image = new Image();
	image.src = data.img;
	image.onload = function(){
		$(".view").scrollTop($(".chat-bar").height())
	}
})


//图片太多没返回会断,图片太多，做了js压缩	

$(".user-list").on("click","li",function(){
	var username = $(this).find('.name').text();
	var id = $(this).attr("data-id");

	if(username != name){
		$(".one2one-box").css({"display":"flex"}).attr("data-id",id).addClass('scale');
		setTimeout(function(){
			$(".one2one-box").removeClass("scale")
		},500)
		$(".one2one-top-title .text").text("与"+username+"聊天")

		if(dialogObj[id]){
			$(".one2one-chat-bar").html(dialogObj[id].dialog.join(""))
		}else{
			$(".one2one-chat-bar").html("")
		}
		
	}
})
//关闭个人聊天窗口
$(".one2one-top-title i").click(function(){
	$(".one2one-box").removeClass("scale").addClass("scaleBack");

	setTimeout(function(){
		$(".one2one-box").css("display","none").removeClass("scaleBack")
	},500)

	var id = $(".one2one-box").attr("data-id");
	if(dialogObj[id]){
		dialogObj[id].unread = 0
		$(".user-list li[data-id="+id+"]").find(".num").remove()
	}

	msgNum();

	
})

//发送消息
$(".one2one-sendBtn").click(function(){
	var val = $(".one2one-send").val();
	if(!val){
		return
	}
  
	var color = $("#one2one-color").val();	
	var id = $(".one2one-box").attr("data-id");	
	socket.emit('one2one_send', {val, color, id, avatarData});
	$(".one2one-send").val(''); 

})
//接收自己发送的消息
socket.on("one2one_send_success",function(data){
	
	var html = createTextLi(data,'right')
	//roomDia.push(html);

	var id = data.id;
	if(dialogObj[id]){
		dialogObj[id].dialog.push(html)
	}else{
		dialogObj[id] = {};
		dialogObj[id].unread = 0;
		dialogObj[id].dialog = [];
		dialogObj[id].dialog.push(html)
	}
	$(".one2one-chat-bar").html(dialogObj[id].dialog.join(""))
	$(".one2one-view").scrollTop($(".one2one-chat-bar").height())
})
//接收one2one发送的消息
socket.on("receive_message",function(data){
	var html = createTextLi(data,'left')
	//roomDia.push(html);
	var id = data.userId;	
	if(dialogObj[id]){
		dialogObj[id].dialog.push(html)
		dialogObj[id].unread += 1;
	}else{
		dialogObj[id] = {};
		dialogObj[id].unread = 1;
		dialogObj[id].dialog = [];
		dialogObj[id].dialog.push(html)
	}
	$(".one2one-chat-bar").html(dialogObj[id].dialog.join(""))
	$(".one2one-view").scrollTop($(".one2one-chat-bar").height())
	displayUser(data);
	msgNum();
})

//发送图片
$("#one2one-file").change(function(){
	var id = $(".one2one-box").attr("data-id");	

	var file = this.files[0];
	if(file.size/1024 > 40){ //大于40kb
		photoCompress(
			file,
			{
				quality: 0.6,
				width: 260
			},
			function(base64){
				emitPic(base64)
			}
		)
	}else{
		var reader = new FileReader();
		reader.readAsDataURL(file)
		reader.onerror = function(){
			console.log('读取文件失败，请重试！')
		}
		reader.onload = function() {
			var src = reader.result;
			emitPic(src)
		}
	}

	function emitPic(src) {
		socket.emit('one2one_sendPic',{
			img: src,
			id: id,
			avatarData
		})
		$("#one2one-file").val("")
	}	
})


//接收自己发送的图片		
socket.on("one2one_sendPic_success",function(data){
	var html = createTextLi(data,'right');

	var id = data.id;
	if(dialogObj[id]){
		dialogObj[id].dialog.push(html)
	}else{
		dialogObj[id] = {};
		dialogObj[id].dialog = [];
		dialogObj[id].dialog.push(html)
	}
	$(".one2one-chat-bar").html(dialogObj[id].dialog.join(""))

	//图片加载完再滚动条到底部
	var image = new Image();
	image.src = data.img;
	image.onload = function(){
		$(".one2one-view").scrollTop($(".one2one-chat-bar").height())
	}
	
})
//接收其他人发送的图片
socket.on("receive_pic",function(data){
	var html = createTextLi(data,'left');

	var id = data.userId;	
	if(dialogObj[id]){
		dialogObj[id].dialog.push(html)
		dialogObj[id].unread += 1;
	}else{
		dialogObj[id] = {};
		dialogObj[id].unread = 1;
		dialogObj[id].dialog = [];
		dialogObj[id].dialog.push(html)
	}
	$(".one2one-chat-bar").html(dialogObj[id].dialog.join(""))	
	var image = new Image();
	image.src = data.img;
	image.onload = function(){
		$(".one2one-view").scrollTop($(".one2one-chat-bar").height())
	}
	displayUser(data);
	msgNum();
})


	
</script>
</html>