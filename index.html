<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=1,minimum-scale=1">
	<title>chat room</title>
	<script type="text/javascript">
		(function(){
			var html = document.documentElement;
			var hWidth = html.getBoundingClientRect().width;
			if(hWidth >= 500){
				document.documentElement.style.width = "500px"
				hWidth = 500
			}
			html.style.fontSize = (hWidth / 750) * 100 + "px";
		})();
	</script>
	<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/static/index.css">
</head>
<body>
<div class="page">
	<div class="login-box">
		<h3>用户登录</h3>
		<input type="text" name="name" class="name" placeholder="请输入登录用名">
		<button class="loginBtn">登录</button>
	</div>
	<div class="menu">
		<ul class="user-list">
			
		</ul>
	</div>
	<div class="room-box">
		<div class="top-title">
			聊天室在线人数（<span class="userNum"></span>）
			<img src="/static/left.png" id="img">
		</div>
		<div class="view">
			<div class="chat-bar">
				
			</div>
		</div>
		<div class="other-send">
			<div class="img-click pic-click">
				<img src="/static/pic.png">
				<input type="file" id="file" accept="image/*">
			</div>	
			<div class="img-click emoji-click">		
				<img src="/static/emoj.png">
			</div>
			<div class="img-click icon-click">
				<i class="iconfont font">&#xe630;</i>
				<input type="color" name="color" value="#000000" id="color">		
			</div>
		</div>
		<div class="bottom-side">
			<input type="text" name="send" class="send">
			<button class="sendBtn">发送</button>
		</div>
		<div class="emoji-box">
			
		</div>
	</div>
</div>
</body>
<script src="/static/socket.io.js"></script>
<script src="/static/compress.js"></script>
<script type="text/javascript">
	var w = $(".menu").width();
	var flag = false;
	var menuIsOpen = false;
	var goBack = false;

	$(".top-title").click(function(){
		if(menuIsOpen){
			menuClose()
		}else{
			menuOpen()
		}	
	})
	$(".view").click(function(){
		if(menuIsOpen){
			menuClose()
		}
	})
	function menuOpen(){
		$(".menu").animate({"left": 0})
		$(".room-box").animate({"left": w + "px"},function(){
			menuIsOpen = true
			$("#img").attr("src","/static/right.png")
		})		
		
	}
	function menuClose(){
		$(".menu").animate({"left": -w + "px"})
		$(".room-box").animate({"left": 0},function(){
			$("#img").attr("src","/static/left.png")
			menuIsOpen = false
		})		
	}


	var startX = 0;
	var startY = 0;
	var dir = {
		x: false,
		y: false
	};
	var isFirst = true;

	$("body").on("touchstart",function(e){
		startX = e.targetTouches[0].clientX;
		startY = e.targetTouches[0].clientY;
		if((startX < 5 && $(".login-box").css("display") == "none") || menuIsOpen){
			flag = true;
		}	
		
		if(e.target.className == "menu" && menuIsOpen){
			goBack = true;
		}	
	})	

	$("body").on("touchmove",function(e){
		if(!flag){
			return
		}			
		var nowX = e.targetTouches[0].clientX;
		var nowY = e.targetTouches[0].clientY;
		var dis = nowX - startX;

		if(isFirst){
			if(Math.abs(nowX-startX) > Math.abs(nowY-startY)){
				dir.x = true;
				isFirst = false;			
			}else{
				dir.y = true;
				isFirst = false;
			}
		}
		if(dir.x){
			if(goBack){
				$(".menu").css({"left": (0 + dis > 0 ? 0 : dis) + "px"})
				$(".room-box").css({"left": (w + dis > w ? w : w + dis) + "px"})
			}else{
				$(".menu").css({"left": (nowX - w < 0 ? nowX - w : 0) + "px"})
				$(".room-box").css({"left": (nowX < w ? nowX : w) + "px"})
			}
		}
		
	})
	$("body").on("touchend",function(e){
		isFirst = true;

		if(flag&&dir.x){
			var endX = e.changedTouches[0].clientX;
			var scale = (w - endX) / w;

			flag = false;
			goBack = false;
			dir.x = false;

			if(scale < 0.2){
				menuOpen&&menuOpen.call(this)
			}else{
				menuClose&&menuClose.call(this)
			}
		}
		
	})
	
</script>

<script>
	var html = '';
	for (var i = 1; i < 142; i++) {
		html += '<img src="/static/emoji/emoji ('+i+').png">'
		$('.emoji-box').html(html)
	}

	$(".emoji-click").click(function(){
		$(".emoji-box").css("display","flex")
	})
	$(".emoji-box").on("click","img",function(){
		var reg = /\((\d+)\)/
		reg.test(this.src)
		var num = RegExp.$1
		$(".send").val($(".send").val()+"["+num+"]")
		$(".emoji-box").css("display","none")
	})
	var socket = io.connect();
	$(".loginBtn").click(function(){
		var username = $(".name").val();
		if(!username){
			alert('请输入登录用名')
			return
		}
		
		socket.emit('login', username);				
	})

	$("#file").change(function(){
		var file = this.files[0];
		if(file.size/1024 > 200){ //大于200kb
			photoCompress(
				file,
				{
					quality: 0.2,
				},
				function(base64){
					socket.emit('sendPic',{
						img: base64
					})
					$("#file").val("")
				}
			)
		}else{
			var reader = new FileReader();
			reader.readAsDataURL(file)
			reader.onerror = function(){
				console.log('读取文件失败，请重试！')
			}
			reader.onload = function() {
				var src = reader.result;
				var img = new Image;
				img.src = src 
				
			}
		}

		
	})
	socket.on('user_login_success',function(data){
		$(".login-box").hide()
		$(".room-box").css("display","flex")
		displayUser(data)
	})

	socket.on('login_success',function(data){
		var html = `<div class="sys-msg">
						<span>系统消息：${data.username}已加入群聊</span>
					</div>`
		$(".chat-bar").append(html)
		$(".view").scrollTop($(".chat-bar").height())
		displayUser(data)
	})
	socket.on('login_fail',function(msg){
		alert("用户已存在")
	})
	socket.on('logout_success',function(data){
		console.log(data)
		var html = `<div class="sys-msg">
						<span>缪文文提醒：${data.user}已退出群聊</span>
					</div>`
		$(".chat-bar").append(html)
		$(".view").scrollTop($(".chat-bar").height())
		displayUser(data)
	})

	socket.on("logout",function(){
		$(".login-box").show()
		$(".room-box").hide()
	})

	function displayUser (data) {
		var {users, username} = data;
		var len = users.length;
		$(".userNum").html(len);
		var html = "";
		for (var i = 0; i < len; i++) {
			if(users[i] == username){
				html += `<li>
							<img src="/static/user.jpg">
							<span>${users[i]}</span>
							<span class="dot"></span>
						</li>`
				continue
			}
			html += `<li>
						<img src="/static/user.jpg">
						<span>${users[i]}</span>
					</li>`
		}
		$(".user-list").html(html)
	}

	$(".sendBtn").click(function(){
		var val = $(".send").val();
		if(!val){
			return
		}
		var color = $("#color").val();		
		socket.emit('send', {val: val, color: color});
		$(".send").val(''); 

	})
	 $("#color").change(function(){
	 	var color = $("#color").val();
	 	$(".font").css("color",color);
	 })
	
	socket.on("send_success",function(data){
		var newVal = data.val.replace(/\[(\d+)\]/g,function(match,p1){
			return '<img src="/static/emoji/emoji ('+p1+').png">'
		})
		
		var html = `<div class="chat-li right-li">
						<img src="/static/user.jpg">
						<div class="message-box">
							<div class="msg" style="color:${data.color}">
								${newVal}
							</div>
						</div>
					</div>`
		$(".chat-bar").append(html)
		$(".view").scrollTop($(".chat-bar").height())
	})
	socket.on("boradcast",function(data){
		var newVal = data.val.replace(/\[(\d+)\]/g,function(match,p1){
			return '<img src="/static/emoji/emoji ('+p1+').png">'
		})
		
		var html = `<div class="chat-li left-li">
						<img src="/static/user.jpg">
						<div class="message-box">
							<p>${data.username}</p>
							<div class="msg" style="color:${data.color}">
								${newVal}
							</div>
						</div>
					</div>`;
		$(".chat-bar").append(html)
		$(".view").scrollTop($(".chat-bar").height())
	})

				
	socket.on("sendPic_success",function(img){
		var html = `<div class="chat-li right-li">
					<img src="/static/user.jpg">
					<div class="message-box">
						<div class="img-box">
							<img src="${img}">
						</div>
					</div>
				</div>`
		$(".chat-bar").append(html)
		//图片加载完再滚动条到底部
		var image = new Image();
		image.src = img;
		image.onload = function(){
			$(".view").scrollTop($(".chat-bar").height())
		}
		
	})
	socket.on("boradcastPic",function(data){
		var html = `<div class="chat-li left-li">
						<img src="/static/user.jpg">
						<div class="message-box">
							<p>${data.username}</p>
							<div class="message-box">
								<div class="img-box">
									<img src="${data.img}">
								</div>
							</div>
						</div>
					</div>`;
		$(".chat-bar").append(html)
		var image = new Image();
		image.src = data.img;
		image.onload = function(){
			$(".view").scrollTop($(".chat-bar").height())
		}
	})

	//图片太多没返回会断	
	
</script>
</html>